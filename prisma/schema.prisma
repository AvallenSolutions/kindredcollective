generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============= ENUMS =============

enum UserRole {
  BRAND
  SUPPLIER
  ADMIN
}

enum DrinkCategory {
  SPIRITS
  BEER
  WINE
  RTD
  NO_LO
  CIDER
  OTHER
}

enum SupplierCategory {
  PACKAGING
  INGREDIENTS
  LOGISTICS
  CO_PACKING
  DESIGN
  MARKETING
  EQUIPMENT
  CONSULTING
  LEGAL
  FINANCE
  DISTRIBUTION
  RECRUITMENT
  SOFTWARE
  SUSTAINABILITY
  PR
  PHOTOGRAPHY
  WEB_DEVELOPMENT
  OTHER
}

enum Certification {
  ORGANIC
  B_CORP
  FAIRTRADE
  VEGAN
  GLUTEN_FREE
  PLASTIC_FREE
  CARBON_NEUTRAL
  OTHER
}

enum EventType {
  TRADE_SHOW
  MEETUP
  WORKSHOP
  WEBINAR
  NETWORKING
  LAUNCH
  PARTY
  OTHER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum OfferType {
  PERCENTAGE_DISCOUNT
  FIXED_DISCOUNT
  FREE_TRIAL
  BUNDLE
  OTHER
}

enum OfferStatus {
  DRAFT
  ACTIVE
  EXPIRED
  PAUSED
}

enum RsvpStatus {
  GOING
  INTERESTED
  NOT_GOING
}

enum ClaimStatus {
  UNCLAIMED
  PENDING
  CLAIMED
  REJECTED
}

// ============= USERS & AUTH =============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  role          UserRole
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  brand           Brand?
  supplier        Supplier?
  member          Member?
  eventRsvps      EventRsvp[]
  savedSuppliers  SavedSupplier[]
  savedBrands     SavedBrand[]
  offerClaims     OfferClaim[]
  supplierClaims  SupplierClaim[]
  reviews         SupplierReview[]
  organisationMembers OrganisationMember[]

  @@index([email])
  @@index([role])
}

// ============= MEMBER PROFILES =============

model Member {
  id          String   @id @default(cuid())
  userId      String   @unique
  firstName   String
  lastName    String
  jobTitle    String?
  bio         String?  @db.Text
  avatarUrl   String?
  linkedinUrl String?
  phone       String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([firstName, lastName])
}

// ============= BRANDS =============

model Brand {
  id            String        @id @default(cuid())
  userId        String        @unique
  name          String
  slug          String        @unique
  tagline       String?
  description   String?       @db.Text
  story         String?       @db.Text
  logoUrl       String?
  heroImageUrl  String?
  websiteUrl    String?
  instagramUrl  String?
  linkedinUrl   String?
  twitterUrl    String?
  category      DrinkCategory
  subcategories String[]
  yearFounded   Int?
  location      String?
  country       String?
  isVerified    Boolean       @default(false)
  isPublic      Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  images  BrandImage[]
  savedBy SavedBrand[]
  reviews SupplierReview[]
  organisation Organisation?
  workRelationships WorkRelationship[]

  @@index([slug])
  @@index([category])
  @@index([location])
  @@index([name])
}

model BrandImage {
  id        String   @id @default(cuid())
  brandId   String
  url       String
  alt       String?
  order     Int      @default(0)
  createdAt DateTime @default(now())

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
}

// ============= SUPPLIERS =============

model Supplier {
  id              String           @id @default(cuid())
  userId          String?          @unique  // Nullable for unclaimed profiles
  companyName     String
  slug            String           @unique
  tagline         String?
  description     String?          @db.Text
  logoUrl         String?
  heroImageUrl    String?
  websiteUrl      String?
  linkedinUrl     String?
  instagramUrl    String?
  portfolioUrl    String?
  category        SupplierCategory
  subcategories   String[]
  services        String[]
  certifications  Certification[]
  moqMin          Int?
  moqMax          Int?
  leadTimeDays    Int?
  location        String?
  country         String?
  serviceRegions  String[]
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  isVerified      Boolean          @default(false)
  isPublic        Boolean          @default(true)
  claimStatus     ClaimStatus      @default(UNCLAIMED)
  viewCount       Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  user            User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  offers          Offer[]
  savedBy         SavedSupplier[]
  portfolioImages SupplierImage[]
  reviews         SupplierReview[]
  claims          SupplierClaim[]
  organisation    Organisation?
  workRelationships WorkRelationship[]

  @@index([slug])
  @@index([category])
  @@index([location])
  @@index([companyName])
  @@index([claimStatus])
}

model SupplierImage {
  id         String   @id @default(cuid())
  supplierId String
  url        String
  alt        String?
  order      Int      @default(0)
  createdAt  DateTime @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
}

// ============= SUPPLIER REVIEWS =============

model SupplierReview {
  id              String   @id @default(cuid())
  supplierId      String
  brandId         String?  // Optional - can be from non-registered reviewers
  userId          String?  // The user who submitted the review
  reviewerName    String
  reviewerCompany String?
  rating          Int      // 1-5 stars
  title           String?
  content         String   @db.Text
  wouldRecommend  Boolean  @default(true)
  serviceRating   Int?     // 1-5
  valueRating     Int?     // 1-5
  isVerified      Boolean  @default(false)
  isPublic        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  brand    Brand?   @relation(fields: [brandId], references: [id], onDelete: SetNull)
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([supplierId])
  @@index([rating])
}

// ============= SUPPLIER CLAIMS =============

model SupplierClaim {
  id              String      @id @default(cuid())
  supplierId      String
  userId          String
  status          ClaimStatus @default(PENDING)
  companyEmail    String      // Email used to verify ownership
  verificationCode String?
  notes           String?     @db.Text
  processedAt     DateTime?
  processedBy     String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([supplierId, userId])
  @@index([status])
}

// ============= OFFERS & DISCOUNTS =============

model Offer {
  id              String      @id @default(cuid())
  supplierId      String
  title           String
  description     String?     @db.Text
  type            OfferType
  discountValue   Decimal?
  code            String?
  termsConditions String?     @db.Text
  status          OfferStatus @default(DRAFT)
  startDate       DateTime?
  endDate         DateTime?
  forBrandsOnly   Boolean     @default(false)
  minOrderValue   Decimal?
  imageUrl        String?
  viewCount       Int         @default(0)
  claimCount      Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  supplier Supplier     @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  claims   OfferClaim[]

  @@index([status])
  @@index([supplierId])
  @@index([endDate])
}

model OfferClaim {
  id        String   @id @default(cuid())
  offerId   String
  userId    String
  claimedAt DateTime @default(now())

  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([offerId, userId])
}

// ============= EVENTS =============

model Event {
  id              String      @id @default(cuid())
  title           String
  slug            String      @unique
  description     String?     @db.Text
  type            EventType
  status          EventStatus @default(DRAFT)
  startDate       DateTime
  endDate         DateTime?
  timezone        String      @default("Europe/London")
  isVirtual       Boolean     @default(false)
  venueName       String?
  address         String?
  city            String?
  country         String?
  virtualUrl      String?
  imageUrl        String?
  capacity        Int?
  isFree          Boolean     @default(true)
  price           Decimal?
  registrationUrl String?
  showAttendees   Boolean     @default(true)
  isFeatured      Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  createdById     String?

  rsvps EventRsvp[]

  @@index([startDate])
  @@index([status])
  @@index([type])
}

model EventRsvp {
  id        String     @id @default(cuid())
  eventId   String
  userId    String
  status    RsvpStatus
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
}

// ============= SAVED/BOOKMARKS =============

model SavedSupplier {
  id         String   @id @default(cuid())
  userId     String
  supplierId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([userId, supplierId])
}

model SavedBrand {
  id        String   @id @default(cuid())
  userId    String
  brandId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([userId, brandId])
}

// ============= NEWS/RSS =============

model NewsSource {
  id        String        @id @default(cuid())
  name      String
  feedUrl   String        @unique
  siteUrl   String?
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())

  articles NewsArticle[]
}

model NewsArticle {
  id          String     @id @default(cuid())
  sourceId    String
  title       String
  url         String     @unique
  description String?    @db.Text
  imageUrl    String?
  publishedAt DateTime
  fetchedAt   DateTime   @default(now())

  source NewsSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([publishedAt])
}

// ============= SEARCH ANALYTICS =============

model SearchQuery {
  id           String   @id @default(cuid())
  query        String
  userId       String?
  resultCount  Int
  processingMs Int
  usedAI       Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([query])
}

// ============= ORGANISATIONS =============

model Organisation {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  type      UserRole // BRAND or SUPPLIER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members OrganisationMember[]
  invites OrganisationInvite[]

  // Link to brand or supplier
  brandId    String?   @unique
  brand      Brand?    @relation(fields: [brandId], references: [id], onDelete: SetNull)
  supplierId String?   @unique
  supplier   Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)

  @@index([slug])
  @@index([type])
}

model OrganisationMember {
  id             String   @id @default(cuid())
  organisationId String
  userId         String
  isOwner        Boolean  @default(false)
  joinedAt       DateTime @default(now())

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organisationId, userId])
  @@index([userId])
}

model OrganisationInvite {
  id             String    @id @default(cuid())
  organisationId String
  email          String
  token          String    @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime  @default(now())
  createdById    String

  organisation Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
}

// ============= WORK RELATIONSHIPS (VERIFICATION) =============

model WorkRelationship {
  id               String    @id @default(cuid())
  brandId          String
  supplierId       String
  brandVerified    Boolean   @default(false)
  supplierVerified Boolean   @default(false)
  projectDate      DateTime?
  projectDescription String? @db.Text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  brand    Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([brandId, supplierId])
  @@index([brandId])
  @@index([supplierId])
}
